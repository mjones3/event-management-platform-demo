# Save this as: .github/workflows/scaffold-service.yml

name: Scaffold a new service

on:
  workflow_dispatch:
    inputs:
      service_name:
        required: true
        description: 'The name of the new service'
        type: string
      description:
        required: false
        description: 'Description of the service'
        type: string
        default: 'A new microservice'
      port_run_id:
        required: false
        description: 'Port run ID for logging'
        type: string

env:
  ORG_NAME: your-org-name  # Replace with your actual GitHub org/username

jobs:
  scaffold-service:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Display inputs (for debugging)
        run: |
          echo "=== INPUTS ==="
          echo "Service Name: ${{ inputs.service_name }}"
          echo "Description: ${{ inputs.description }}"
          echo "Port Run ID: ${{ inputs.port_run_id }}"
          echo ""
          echo "=== GITHUB CONTEXT ==="
          echo "Triggered by: ${{ github.actor }}"
          echo "Repository: ${{ github.repository }}"
          echo "Event: ${{ github.event_name }}"
          echo ""
          echo "=== PORT RUN ID CHECK ==="
          if [ -n "${{ inputs.port_run_id }}" ]; then
            echo "✅ Port run ID is present: ${{ inputs.port_run_id }}"
          else
            echo "❌ Port run ID is missing"
          fi

      - name: Test Port connection (simple)
        if: ${{ inputs.port_run_id != '' }}
        continue-on-error: true
        uses: port-labs/port-github-action@v1
        with:
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          baseUrl: https://api.getport.io
          operation: PATCH_RUN
          runId: ${{ inputs.port_run_id }}
          logMessage: "🚀 Starting scaffolding of service: ${{ inputs.service_name }}"

      - name: Set up Java for OpenAPI generation
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Generate Spring Boot service from OpenAPI spec
        run: |
          set -e  # Exit on any error
          SERVICE_NAME="${{ inputs.service_name }}"
          
          echo "🔧 Starting service generation for: $SERVICE_NAME"
          
          # Validate service name
          if [[ ! "$SERVICE_NAME" =~ ^[a-z][a-z0-9-]*[a-z0-9]$ ]] || [[ ${#SERVICE_NAME} -lt 3 ]] || [[ ${#SERVICE_NAME} -gt 50 ]]; then
            echo "❌ Invalid service name: $SERVICE_NAME"
            echo "Service name must be 3-50 characters, lowercase, kebab-case (e.g., my-service)"
            exit 1
          fi
          
          # Create directory for the new service
          mkdir -p "$SERVICE_NAME"
          cd "$SERVICE_NAME"
          
          # Download OpenAPI Generator CLI
          echo "📥 Downloading OpenAPI Generator..."
          if ! wget -q https://repo1.maven.org/maven2/org/openapitools/openapi-generator-cli/7.2.0/openapi-generator-cli-7.2.0.jar -O openapi-generator-cli.jar; then
            echo "❌ Failed to download OpenAPI Generator"
            exit 1
          fi
          
          # Verify download
          if [[ ! -f "openapi-generator-cli.jar" ]] || [[ ! -s "openapi-generator-cli.jar" ]]; then
            echo "❌ OpenAPI Generator download failed or file is empty"
            exit 1
          fi
          
          echo "✅ OpenAPI Generator downloaded successfully ($(ls -lh openapi-generator-cli.jar | awk '{print $5}'))"
          
          # Download your actual OpenAPI spec
          echo "📋 Fetching OpenAPI specification..."
          
          SPEC_FOUND=false
          
          # Try multiple locations for the OpenAPI spec
          if wget -q https://raw.githubusercontent.com/mjones3/event-management-platform-demo/main/api-specs/user-service.yaml -O api-spec.yaml 2>/dev/null && [[ -s api-spec.yaml ]]; then
            echo "✅ Downloaded OpenAPI spec from api-specs directory"
            SPEC_FOUND=true
          elif wget -q https://raw.githubusercontent.com/mjones3/event-management-platform-demo/main/openapi/user-service.yaml -O api-spec.yaml 2>/dev/null && [[ -s api-spec.yaml ]]; then
            echo "✅ Downloaded OpenAPI spec from openapi directory"
            SPEC_FOUND=true
          elif wget -q https://raw.githubusercontent.com/mjones3/event-management-platform-demo/main/docs/api/user-service.yaml -O api-spec.yaml 2>/dev/null && [[ -s api-spec.yaml ]]; then
            echo "✅ Downloaded OpenAPI spec from docs directory"
            SPEC_FOUND=true
          fi
          
          if [[ "$SPEC_FOUND" == "false" ]]; then
            echo "⚠️  Could not find existing OpenAPI spec, creating a template based on service name..."
            
            # Create a generic microservice spec based on the service name
            SERVICE_NAME_CAMEL="$(echo ${SERVICE_NAME} | sed 's/-\([a-z]\)/\U\1/g' | sed 's/^\([a-z]\)/\U\1/')"
            
            cat > api-spec.yaml << 'SPEC_EOF'
          openapi: 3.0.3
          info:
            title: SERVICE_NAME_CAMEL_PLACEHOLDER Service API
            description: SERVICE_DESCRIPTION_PLACEHOLDER
            version: 1.0.0
            contact:
              name: API Support
              email: support@eventplatform.com
          servers:
            - url: https://api.eventplatform.com/SERVICE_NAME_PLACEHOLDER/v1
              description: Production server
            - url: http://localhost:8080/api/v1
              description: Development server
          
          security:
            - BearerAuth: []
          
          paths:
            /health:
              get:
                summary: Health check endpoint
                description: Returns the health status of the service
                tags:
                  - Health
                security: []
                responses:
                  '200':
                    description: Service is healthy
                    content:
                      application/json:
                        schema:
                          $ref: '#/components/schemas/HealthResponse'
            
            /SERVICE_NAME_PLACEHOLDER_PLURAL:
              get:
                summary: List SERVICE_NAME_PLACEHOLDER_PLURAL with pagination
                description: Retrieve a paginated list with optional filtering
                tags:
                  - SERVICE_NAME_CAMEL_PLACEHOLDER
                parameters:
                  - name: page
                    in: query
                    description: Page number (0-based)
                    schema:
                      type: integer
                      minimum: 0
                      default: 0
                  - name: size
                    in: query
                    description: Page size
                    schema:
                      type: integer
                      minimum: 1
                      maximum: 100
                      default: 20
                  - name: search
                    in: query
                    description: Search term
                    schema:
                      type: string
                      minLength: 2
                responses:
                  '200':
                    description: Successfully retrieved items
                    content:
                      application/json:
                        schema:
                          $ref: '#/components/schemas/PagedSERVICE_NAME_CAMEL_PLACEHOLDERResponse'
                  '400':
                    $ref: '#/components/responses/BadRequest'
                  '401':
                    $ref: '#/components/responses/Unauthorized'
              post:
                summary: Create a new item
                description: Create a new item in the system
                tags:
                  - SERVICE_NAME_CAMEL_PLACEHOLDER
                requestBody:
                  required: true
                  content:
                    application/json:
                      schema:
                        $ref: '#/components/schemas/CreateSERVICE_NAME_CAMEL_PLACEHOLDERRequest'
                responses:
                  '201':
                    description: Item created successfully
                    content:
                      application/json:
                        schema:
                          $ref: '#/components/schemas/SERVICE_NAME_CAMEL_PLACEHOLDERResponse'
                  '400':
                    $ref: '#/components/responses/BadRequest'
                  '401':
                    $ref: '#/components/responses/Unauthorized'
            
            /SERVICE_NAME_PLACEHOLDER_PLURAL/{id}:
              get:
                summary: Get item by ID
                description: Retrieve detailed information about a specific item
                tags:
                  - SERVICE_NAME_CAMEL_PLACEHOLDER
                parameters:
                  - name: id
                    in: path
                    required: true
                    description: Item ID
                    schema:
                      type: string
                      format: uuid
                responses:
                  '200':
                    description: Item found
                    content:
                      application/json:
                        schema:
                          $ref: '#/components/schemas/SERVICE_NAME_CAMEL_PLACEHOLDERResponse'
                  '404':
                    $ref: '#/components/responses/NotFound'
                  '401':
                    $ref: '#/components/responses/Unauthorized'
              put:
                summary: Update item
                description: Update item information (full update)
                tags:
                  - SERVICE_NAME_CAMEL_PLACEHOLDER
                parameters:
                  - name: id
                    in: path
                    required: true
                    schema:
                      type: string
                      format: uuid
                requestBody:
                  required: true
                  content:
                    application/json:
                      schema:
                        $ref: '#/components/schemas/UpdateSERVICE_NAME_CAMEL_PLACEHOLDERRequest'
                responses:
                  '200':
                    description: Item updated successfully
                    content:
                      application/json:
                        schema:
                          $ref: '#/components/schemas/SERVICE_NAME_CAMEL_PLACEHOLDERResponse'
                  '400':
                    $ref: '#/components/responses/BadRequest'
                  '404':
                    $ref: '#/components/responses/NotFound'
              delete:
                summary: Delete item
                description: Delete an item
                tags:
                  - SERVICE_NAME_CAMEL_PLACEHOLDER
                parameters:
                  - name: id
                    in: path
                    required: true
                    schema:
                      type: string
                      format: uuid
                responses:
                  '204':
                    description: Item deleted successfully
                  '404':
                    $ref: '#/components/responses/NotFound'
                  '401':
                    $ref: '#/components/responses/Unauthorized'
          
          components:
            securitySchemes:
              BearerAuth:
                type: http
                scheme: bearer
                bearerFormat: JWT
            
            schemas:
              HealthResponse:
                type: object
                properties:
                  status:
                    type: string
                    example: "UP"
                  service:
                    type: string
                    example: "SERVICE_NAME_PLACEHOLDER"
                  timestamp:
                    type: string
                    format: date-time
                  version:
                    type: string
                    example: "1.0.0"
                required:
                  - status
                  - service
                  - timestamp
              
              SERVICE_NAME_CAMEL_PLACEHOLDERResponse:
                type: object
                properties:
                  id:
                    type: string
                    format: uuid
                    example: "550e8400-e29b-41d4-a716-446655440000"
                  name:
                    type: string
                    example: "Sample Item"
                  description:
                    type: string
                    example: "A sample item description"
                  status:
                    type: string
                    enum: [ACTIVE, INACTIVE, PENDING]
                    example: "ACTIVE"
                  createdAt:
                    type: string
                    format: date-time
                    example: "2024-01-15T10:30:00Z"
                  updatedAt:
                    type: string
                    format: date-time
                    example: "2024-01-20T14:22:00Z"
                required:
                  - id
                  - name
                  - status
                  - createdAt
              
              CreateSERVICE_NAME_CAMEL_PLACEHOLDERRequest:
                type: object
                properties:
                  name:
                    type: string
                    minLength: 1
                    maxLength: 100
                    example: "New Item"
                  description:
                    type: string
                    maxLength: 500
                    example: "Description of the new item"
                required:
                  - name
              
              UpdateSERVICE_NAME_CAMEL_PLACEHOLDERRequest:
                type: object
                properties:
                  name:
                    type: string
                    minLength: 1
                    maxLength: 100
                  description:
                    type: string
                    maxLength: 500
                  status:
                    type: string
                    enum: [ACTIVE, INACTIVE, PENDING]
              
              PagedSERVICE_NAME_CAMEL_PLACEHOLDERResponse:
                type: object
                properties:
                  content:
                    type: array
                    items:
                      $ref: '#/components/schemas/SERVICE_NAME_CAMEL_PLACEHOLDERResponse'
                  totalElements:
                    type: integer
                    format: int64
                    example: 150
                  totalPages:
                    type: integer
                    example: 8
                  size:
                    type: integer
                    example: 20
                  number:
                    type: integer
                    example: 0
                  first:
                    type: boolean
                    example: true
                  last:
                    type: boolean
                    example: false
                required:
                  - content
                  - totalElements
                  - totalPages
                  - size
                  - number
                  - first
                  - last
              
              ErrorResponse:
                type: object
                properties:
                  timestamp:
                    type: string
                    format: date-time
                    example: "2024-01-20T15:30:45Z"
                  status:
                    type: integer
                    example: 400
                  error:
                    type: string
                    example: "Bad Request"
                  message:
                    type: string
                    example: "Validation failed"
                  path:
                    type: string
                    example: "/api/v1/items"
                required:
                  - timestamp
                  - status
                  - error
                  - message
                  - path
            
            responses:
              BadRequest:
                description: Bad request - validation errors
                content:
                  application/json:
                    schema:
                      $ref: '#/components/schemas/ErrorResponse'
              
              Unauthorized:
                description: Authentication required
                content:
                  application/json:
                    schema:
                      $ref: '#/components/schemas/ErrorResponse'
              
              NotFound:
                description: Resource not found
                content:
                  application/json:
                    schema:
                      $ref: '#/components/schemas/ErrorResponse'
          
          tags:
            - name: SERVICE_NAME_CAMEL_PLACEHOLDER
              description: Item management operations
            - name: Health
              description: Service health endpoints
          SPEC_EOF
          
            # Replace placeholders in the spec
            sed -i "s/SERVICE_NAME_PLACEHOLDER/${SERVICE_NAME}/g" api-spec.yaml
            sed -i "s/SERVICE_NAME_CAMEL_PLACEHOLDER/${SERVICE_NAME_CAMEL}/g" api-spec.yaml
            sed -i "s/SERVICE_DESCRIPTION_PLACEHOLDER/${{ inputs.description }}/g" api-spec.yaml
            sed -i "s/SERVICE_NAME_PLACEHOLDER_PLURAL/${SERVICE_NAME}s/g" api-spec.yaml
            
            echo "✅ Generated template OpenAPI spec"
          fi
          
          # Validate the OpenAPI spec
          echo "📄 Validating OpenAPI specification..."
          if [[ ! -s api-spec.yaml ]]; then
            echo "❌ OpenAPI spec file is empty"
            exit 1
          fi
          
          # Show first few lines of the spec
          echo "📄 OpenAPI specification preview:"
          head -15 api-spec.yaml
          echo "..."
          
          # Test if Java is available and working
          echo "☕ Testing Java installation..."
          if ! java -version; then
            echo "❌ Java is not available or not working"
            exit 1
          fi
          
          # Test if the JAR file is executable
          echo "🧪 Testing OpenAPI Generator..."
          if ! java -jar openapi-generator-cli.jar version; then
            echo "❌ OpenAPI Generator is not working"
            exit 1
          fi
          
          # Generate Spring Boot application
          echo "🔧 Generating Spring Boot service..."
          
          PACKAGE_NAME="com.eventplatform.$(echo $SERVICE_NAME | tr '-' '.')"
          
          java -jar openapi-generator-cli.jar generate \
            -i api-spec.yaml \
            -g spring \
            -o . \
            --additional-properties=\
          packageName=${PACKAGE_NAME},\
          apiPackage=${PACKAGE_NAME}.controller,\
          modelPackage=${PACKAGE_NAME}.model,\
          configPackage=${PACKAGE_NAME}.config,\
          basePackage=${PACKAGE_NAME},\
          groupId=com.eventplatform,\
          artifactId=$SERVICE_NAME,\
          artifactVersion=1.0.0,\
          java8=false,\
          dateLibrary=java8,\
          interfaceOnly=false,\
          skipDefaultInterface=false,\
          useTags=true,\
          singleContentTypes=true,\
          performBeanValidation=true,\
          useBeanValidation=true,\
          library=spring-boot,\
          documentationProvider=springdoc,\
          openApiNullable=false,\
          hideGenerationTimestamp=true
          
          # Check if generation was successful
          if [[ ! -f "pom.xml" ]]; then
            echo "❌ Spring Boot generation failed - no pom.xml found"
            ls -la
            exit 1
          fi
          
          echo "✅ Spring Boot service generated successfully!"
          echo "📁 Generated files:"
          find . -name "*.java" -type f | head -10
          echo "..."

      - name: Enhance generated service with microservice features
        run: |
          SERVICE_NAME="${{ inputs.service_name }}"
          cd "$SERVICE_NAME"
          
          # Create enhanced application.yml
          cat > src/main/resources/application.yml << EOF
          server:
            port: 8080
          
          spring:
            application:
              name: $SERVICE_NAME
            datasource:
              url: jdbc:postgresql://\${DB_HOST:localhost}:\${DB_PORT:5432}/\${DB_NAME:${SERVICE_NAME//-/_}_db}
              username: \${DB_USERNAME:postgres}
              password: \${DB_PASSWORD:password}
            jpa:
              hibernate:
                ddl-auto: \${JPA_DDL_AUTO:validate}
              show-sql: \${JPA_SHOW_SQL:false}
              properties:
                hibernate:
                  format_sql: true
            
          management:
            endpoints:
              web:
                exposure:
                  include: health,info,metrics,prometheus
            endpoint:
              health:
                show-details: always
          
          logging:
            level:
              com.eventplatform: \${LOG_LEVEL:INFO}
              org.springframework.web: \${WEB_LOG_LEVEL:WARN}
          
          springdoc:
            api-docs:
              path: /api-docs
            swagger-ui:
              path: /swagger-ui.html
          EOF
          
          # Create Dockerfile
          cat > Dockerfile << 'EOF'
          FROM openjdk:17-jdk-slim
          
          WORKDIR /app
          COPY target/*.jar app.jar
          EXPOSE 8080
          
          ENTRYPOINT ["java", "-jar", "app.jar"]
          EOF
          
          # Create docker-compose.yml
          cat > docker-compose.yml << EOF
          version: '3.8'
          services:
            ${SERVICE_NAME}:
              build: .
              ports:
                - "8080:8080"
              environment:
                - DB_HOST=postgres
                - DB_USERNAME=postgres
                - DB_PASSWORD=password
                - DB_NAME=${SERVICE_NAME//-/_}_db
              depends_on:
                - postgres
            
            postgres:
              image: postgres:15
              environment:
                - POSTGRES_DB=${SERVICE_NAME//-/_}_db
                - POSTGRES_USER=postgres
                - POSTGRES_PASSWORD=password
              ports:
                - "5432:5432"
              volumes:
                - postgres_data:/var/lib/postgresql/data
          
          volumes:
            postgres_data:
          EOF
          
          echo "✅ Enhanced service with microservice features!"

      - name: Create GitHub Repository and push generated code
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          SERVICE_NAME="${{ inputs.service_name }}"
          
          # Create new repository
          gh repo create "${{ github.repository_owner }}/$SERVICE_NAME" \
            --description "${{ inputs.description }} - Generated from OpenAPI specification" \
            --public
          
          # Clone the empty repository
          git clone "https://github.com/${{ github.repository_owner }}/$SERVICE_NAME.git" temp-repo
          
          # Copy generated code to the cloned repo
          cp -r "$SERVICE_NAME"/* temp-repo/
          cd temp-repo
          
          # Create README
          cat > README.md << EOF
          # $SERVICE_NAME
          
          ${{ inputs.description }}
          
          Generated Spring Boot microservice from OpenAPI specification.
          
          ## Quick Start
          
          1. **Start with Docker Compose:**
             \`\`\`bash
             docker-compose up -d
             \`\`\`
          
          2. **Test the API:**
             \`\`\`bash
             curl http://localhost:8080/api/v1/health
             \`\`\`
          
          3. **View API Documentation:**
             \`\`\`
             http://localhost:8080/swagger-ui.html
             \`\`\`
          
          ## Generated by
          - **User:** ${{ github.actor }}
          - **Date:** $(date)
          - **Platform:** Event Management Platform
          EOF
          
          # Initial commit
          git add .
          git commit -m "🎉 Initial commit: OpenAPI-generated $SERVICE_NAME service"
          git push origin main
          
          echo "✅ Repository '$SERVICE_NAME' created!"
          echo "🌐 URL: https://github.com/${{ github.repository_owner }}/$SERVICE_NAME"

      - name: Simulate service creation
        run: |
          echo "Creating service: ${{ inputs.service_name }}"
          echo "Description: ${{ inputs.description }}"
          # Add your actual scaffolding logic here
          sleep 5
          echo "✅ Service scaffolding completed!"

      - name: Log completion to Port
        if: ${{ inputs.port_run_id != '' }}
        continue-on-error: true
        uses: port-labs/port-github-action@v1
        with:
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          baseUrl: https://api.getport.io
          operation: PATCH_RUN
          runId: ${{ inputs.port_run_id }}
          logMessage: "✅ Successfully scaffolded service: ${{ inputs.service_name }}"